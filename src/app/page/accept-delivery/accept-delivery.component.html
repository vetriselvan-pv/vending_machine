<ion-content [fullscreen]="true" class="accept-delivery-content ion-padding">

  <!-- Pending Approvals Section -->
  <ion-card class="pending-card">
    <ion-card-content>
      <div class="section-header">
        <ion-text class="section-title">Pending Approvals</ion-text>
        <ion-text class="section-count">{{ pendingDeliveries().length }} pending</ion-text>
      </div>

      @if(pendingDeliveries() && pendingDeliveries().length > 0) {
        <div class="table-container">
          <ion-grid class="data-table">
            <!-- Table Header -->
            <ion-row class="table-header">
              <ion-col size="2" class="header-col">Delivery #</ion-col>
              <ion-col size="2" class="header-col">Date</ion-col>
              <ion-col size="3" class="header-col">Supplier</ion-col>
              <ion-col size="2" class="header-col">Total Qty</ion-col>
              <ion-col size="2" class="header-col">Status</ion-col>
              <ion-col size="1" class="header-col">Action</ion-col>
            </ion-row>

            <!-- Table Rows -->
            @for (delivery of pendingDeliveries(); track delivery.deliveryId) {
              <ion-row class="table-row">
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text">{{ delivery.deliveryNumber }}</ion-text>
                </ion-col>
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text">{{ delivery.date }}</ion-text>
                </ion-col>
                <ion-col size="3" class="data-col">
                  <ion-text class="data-text">{{ delivery.customerName || delivery.supplier || 'N/A' }}</ion-text>
                </ion-col>
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text">{{ delivery.totalQuantity }}</ion-text>
                </ion-col>
                <ion-col size="2" class="data-col">
                  <ion-text [class]="getStatusBadgeClass(delivery.status)">
                    {{ delivery.status | titlecase }}
                  </ion-text>
                </ion-col>
                <ion-col size="1" class="data-col action-col">
                  <ion-button
                    fill="clear"
                    size="small"
                    (click)="openDeliveryModal(delivery)"
                    class="view-button">
                    <ion-icon slot="icon-only" name="eye-outline"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
            }
          </ion-grid>
        </div>
      } @else {
        <ion-card class="empty-card">
          <ion-card-content>
            <ion-text class="empty-text">No pending deliveries for approval.</ion-text>
          </ion-card-content>
        </ion-card>
      }
    </ion-card-content>
  </ion-card>

  <!-- Accepted Deliveries Section -->
  <ion-card class="accepted-card">
    <ion-card-content>
      <div class="section-header">
        <ion-text class="section-title">Accepted Deliveries</ion-text>
        <ion-text class="section-count">{{ acceptedDeliveries().length }} accepted</ion-text>
      </div>

      @if(acceptedDeliveries() && acceptedDeliveries().length > 0) {
        <div class="table-container">
          <ion-grid class="data-table">
            <!-- Table Header -->
            <ion-row class="table-header">
              <ion-col size="2" class="header-col">Delivery #</ion-col>
              <ion-col size="2" class="header-col">Date</ion-col>
              <ion-col size="3" class="header-col">Supplier</ion-col>
              <ion-col size="2" class="header-col">Accepted Qty</ion-col>
              <ion-col size="3" class="header-col">Status</ion-col>
            </ion-row>

            <!-- Table Rows -->
            @for (delivery of acceptedDeliveries(); track delivery.deliveryId) {
              <ion-row class="table-row">
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text">{{ delivery.deliveryNumber }}</ion-text>
                </ion-col>
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text">{{ delivery.date }}</ion-text>
                </ion-col>
                <ion-col size="3" class="data-col">
                  <ion-text class="data-text">{{ delivery.customerName || delivery.supplier || 'N/A' }}</ion-text>
                </ion-col>
                <ion-col size="2" class="data-col">
                  <ion-text class="data-text quantity-text">{{ delivery.totalAcceptedQty }}</ion-text>
                </ion-col>
                <ion-col size="3" class="data-col">
                  <ion-text [class]="getStatusBadgeClass(delivery.status)">
                    {{ delivery.status | titlecase }}
                  </ion-text>
                </ion-col>
              </ion-row>
            }
          </ion-grid>
        </div>
      } @else {
        <ion-card class="empty-card">
          <ion-card-content>
            <ion-text class="empty-text">No accepted deliveries yet.</ion-text>
          </ion-card-content>
        </ion-card>
      }
    </ion-card-content>
  </ion-card>

  <!-- Delivery Approval Modal -->
  <ion-modal [isOpen]="isModalOpen()" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Approve Delivery: {{ selectedDelivery()?.deliveryNumber }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon slot="icon-only" name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-content">
        @if(selectedDelivery()) {
          <div class="modal-info">
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <ion-text class="info-label">Customer</ion-text>
                  <ion-text class="info-value">{{ selectedDelivery()?.customerName || selectedDelivery()?.supplier || 'N/A' }}</ion-text>
                </ion-col>
                <ion-col size="6">
                  <ion-text class="info-label">Date</ion-text>
                  <ion-text class="info-value">{{ selectedDelivery()?.date }}</ion-text>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div class="products-section">
            <ion-text class="products-title">Products</ion-text>

            @for (product of selectedDelivery()!.products; track product.productId; let i = $index) {
              <ion-card class="product-card">
                <ion-card-content>
                  <ion-grid class="product-grid">
                    <!-- Product Name -->
                    <ion-row class="product-row">
                      <ion-col size="12">
                        <ion-text class="product-label">Product Name</ion-text>
                        <ion-text class="product-name">{{ product.productName }}</ion-text>
                      </ion-col>
                    </ion-row>

                    <!-- Delivered Qty -->
                    <ion-row class="product-row">
                      <ion-col size="6">
                        <ion-text class="product-label">Delivered Qty</ion-text>
                        <ion-text class="product-value">{{ product.deliveredQty }}</ion-text>
                      </ion-col>
                      <ion-col size="6">
                        <ion-text class="product-label">Accepted Qty</ion-text>
                        <ion-text class="product-value accepted-qty">{{ product.acceptedQty }}</ion-text>
                      </ion-col>
                    </ion-row>

                    <!-- Return Qty Input -->
                    <ion-row class="product-row">
                      <ion-col size="12">
                        <div class="input-wrapper">
                          <ion-label class="input-label">Return Qty</ion-label>
                          <ion-item lines="none" class="input-item">
                            <ion-input
                              type="number"
                              [value]="product.returnQty"
                              (ionInput)="updateReturnQty(i, +($any($event.target).value || 0))"
                              [max]="product.deliveredQty"
                              [min]="0"
                              placeholder="Enter return quantity"
                              class="return-input">
                            </ion-input>
                          </ion-item>
                        </div>
                      </ion-col>
                    </ion-row>

                    <!-- Accept/Reject Buttons -->
                    <ion-row class="product-row action-row">
                      <ion-col size="6">
                        <ion-button
                          expand="block"
                          fill="outline"
                          color="success"
                          [class.accepted-btn]="product.status === 'accepted'"
                          (click)="acceptProduct(i)"
                          [disabled]="product.status === 'accepted'">
                          <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                          Accept
                        </ion-button>
                      </ion-col>
                      <ion-col size="6">
                        <ion-button
                          expand="block"
                          fill="outline"
                          color="danger"
                          [class.rejected-btn]="product.status === 'rejected'"
                          (click)="rejectProduct(i)"
                          [disabled]="product.status === 'rejected'">
                          <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                          Reject
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </ion-card-content>
              </ion-card>
            }
          </div>

          <!-- Submit Button -->
          <div class="submit-section">
            <ion-button
              expand="block"
              size="large"
              class="submit-button"
              (click)="submitDelivery()">
              <ion-text><strong>Submit</strong></ion-text>
            </ion-button>
          </div>
        }
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
