<ion-content [fullscreen]="true" class="stock-content ion-padding">

  <!-- Form Section -->
  <ion-card class="form-card" *ngIf="hasAssignedCustomers && customersLoaded">
    <ion-card-content>
      <form [formGroup]="stockManagementForm">
        <ion-grid class="form-grid">
          <!-- Customer Selection Section -->
          <ion-row>
            <ion-col size="12">
              <div class="customer-select-wrapper">
                <ion-item class="customer-select-item" lines="none">
                  <ion-label position="stacked" class="customer-label">Select Customer</ion-label>
                  <ion-select [(ngModel)]="selectedCustomerId" placeholder="Select Customer" interface="action-sheet"
                    class="customer-select" [ngModelOptions]="{standalone: true}"
                    (ionChange)="onCustomerChange($event)">
                    <ion-select-option *ngFor="let customer of customers" [value]="customer.id">
                      {{ customer.name }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </div>
            </ion-col>
          </ion-row>

        </ion-grid>
      </form>
    </ion-card-content>
  </ion-card>

  <ion-card class="form-card" *ngIf="customersLoaded && !hasAssignedCustomers">
    <ion-card-content>
      <ion-grid class="form-grid">
        <ion-row>
          <ion-col size="12">
            <div class="no-customer-message">
              <ion-text color="warning">
                <p class="message-text">
                  <ion-icon name="information-circle-outline"
                    style="vertical-align: middle; margin-right: 8px;"></ion-icon>
                  Please contact admin to assign customer name to your account.
                </p>
              </ion-text>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Products List with Closing Stock Inputs -->
  @if(hasAssignedCustomers && selectedCustomerId) {
  <ion-card class="list-card">
    <ion-card-content>
      <div class="list-header">
        <ion-text class="list-title">Products</ion-text>
        <ion-text class="list-count">{{ productStocks().length }} products</ion-text>
      </div>

      @if(loadingProducts) {
        <div class="stocks-list loading-container">
          <ion-spinner name="crescent"></ion-spinner>
          <ion-text class="loading-text">Loading products...</ion-text>
        </div>
      } @else if(productStocks() && productStocks().length > 0) {
      <div class="stocks-list">
        @for (stock of productStocks(); track stock.productId) {
        <ion-card class="stock-item-card">
          <ion-card-content>
            <ion-grid class="stock-item-grid">
              <ion-row class="stock-item-row">
                <ion-col size="12">
                  <div class="product-header">
                    <div class="product-image-container">
                      @if(stock.productImage) {
                      <img [src]="stock.productImage" [alt]="stock.productName" class="product-image"
                        (error)="stock.productImage = undefined" />
                      }
                      @if(!stock.productImage) {
                      <ion-icon name="image-outline" class="product-icon"></ion-icon>
                      }
                    </div>
                    <div class="product-name-container">
                      <ion-text class="item-label">Product</ion-text>
                      <ion-text class="item-value">{{ stock.productName }}</ion-text>
                      @if(stock.currentAvailableQty !== undefined && stock.currentAvailableQty !== null) {
                        <ion-text class="item-availability">
                          Available: {{ stock.currentAvailableQty }} {{ stock.productUnit || '' }}
                        </ion-text>
                      }
                    </div>
                  </div>
                </ion-col>
              </ion-row>
              <ion-row class="stock-item-row">
                <ion-col size="12">
                  <div class="input-wrapper">
                    <ion-label class="input-label">Closing Stock</ion-label>
                    <ion-item lines="none" class="input-item">
                      <ion-input type="number" [value]="stock.closingStock"
                        (ionInput)="updateClosingStock(stock.productId, +($any($event.target).value || 0))"
                        placeholder="Enter closing stock" [min]="0" class="stock-input">
                      </ion-input>
                    </ion-item>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
        }
      </div>
      } @else {
      <ion-card class="empty-card">
        <ion-card-content>
          <ion-text class="empty-text">No products available for this customer.</ion-text>
        </ion-card-content>
      </ion-card>
      }
    </ion-card-content>
  </ion-card>
  }


  <!-- Submit Button -->
  @if(hasAssignedCustomers && selectedCustomerId && productStocks().length > 0) {
  <ion-button type="submit" expand="block" size="large" class="submit-button" (click)="updateStock()"
    [disabled]="!hasValidClosingStocks()">
    <ion-text><strong>Save Closing Stocks</strong></ion-text>
  </ion-button>
  }

</ion-content>