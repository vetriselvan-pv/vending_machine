<ion-content [fullscreen]="true" class="accept-delivery-content ion-padding">

  <!-- Filter Section -->
  <ion-card class="filter-card">
    <ion-card-content>
      <div class="filter-section">
        <ion-item lines="none" class="filter-item">
          <ion-label position="stacked" class="filter-label">Filter Deliveries</ion-label>
          <ion-select
            [(ngModel)]="filterStatus"
            (ionChange)="onFilterChange($event)"
            interface="action-sheet"
            class="filter-select"
            [ngModelOptions]="{standalone: true}">
            <ion-select-option value="all">All Deliveries</ion-select-option>
            <ion-select-option value="pending">Pending Approvals</ion-select-option>
            <ion-select-option value="accepted">Accepted Deliveries</ion-select-option>
          </ion-select>
        </ion-item>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Deliveries List Section -->
  <ion-card class="deliveries-card">
    <ion-card-content>
      <div class="section-header">
        <ion-text class="section-title">
          @if(filterStatus === 'all') {
            All Deliveries
          } @else if(filterStatus === 'pending') {
            Pending Approvals
          } @else {
            Accepted Deliveries
          }
        </ion-text>
        <ion-text class="section-count">{{ filteredDeliveries().length }} 
          @if(filterStatus === 'all') {
            total
          } @else if(filterStatus === 'pending') {
            pending
          } @else {
            accepted
          }
        </ion-text>
      </div>

      @if(filteredDeliveries() && filteredDeliveries().length > 0) {
        <div class="delivery-cards-container">
          @for (delivery of filteredDeliveries(); track delivery.deliveryId) {
            <ion-card class="delivery-card" [class.accepted-card]="delivery.status === 'accepted'">
              <ion-card-content>
                <!-- Top Section: Delivery Number and Status -->
                <div class="card-header">
                  <div class="delivery-number-section">
                    <ion-text class="delivery-label">Delivery No</ion-text>
                    <ion-text class="delivery-number">#{{ delivery.deliveryNumber }}</ion-text>
                  </div>
                  <ion-text [class]="getStatusBadgeClass(delivery.status)" class="status-badge">
                    {{ delivery.status | titlecase }}
                  </ion-text>
                </div>

                <!-- Supplier Section with Logo -->
                <div class="supplier-section">
                  <div class="supplier-header">
                    <div class="customer-logo-container">
                      @if(delivery.customerLogo) {
                        <img 
                          [src]="delivery.customerLogo" 
                          [alt]="delivery.customerName || delivery.supplier" 
                          class="customer-logo" 
                          (error)="delivery.customerLogo = undefined" />
                      }
                      @if(!delivery.customerLogo) {
                        <ion-icon name="business-outline" class="customer-logo-icon"></ion-icon>
                      }
                    </div>
                    <ion-text class="supplier-name">{{ delivery.customerName || delivery.supplier || 'N/A' }}</ion-text>
                  </div>
                </div>

                <!-- Products and Quantity Info -->
                <div class="info-row">
                  @if(isPendingDelivery(delivery)) {
                    <div class="info-item">
                      <ion-icon name="cube-outline" class="info-icon"></ion-icon>
                      <div class="info-content">
                        <ion-text class="info-label">Products</ion-text>
                        <ion-text class="info-value">{{ delivery.products.length || 0 }}</ion-text>
                      </div>
                    </div>
                    <div class="info-item">
                      <ion-icon name="barcode-outline" class="info-icon"></ion-icon>
                      <div class="info-content">
                        <ion-text class="info-label">Total Qty</ion-text>
                        <ion-text class="info-value">{{ delivery.totalQuantity }}</ion-text>
                      </div>
                    </div>
                  } @else if(isAcceptedDelivery(delivery)) {
                    <div class="info-item">
                      <ion-icon name="checkmark-circle-outline" class="info-icon"></ion-icon>
                      <div class="info-content">
                        <ion-text class="info-label">Accepted Qty</ion-text>
                        <ion-text class="info-value accepted-qty-value">{{ delivery.totalAcceptedQty }}</ion-text>
                      </div>
                    </div>
                  }
                </div>

                <!-- Delivery Date -->
                <div class="date-section">
                  <ion-icon name="calendar-outline" class="date-icon"></ion-icon>
                  <ion-text class="date-text">{{ formatDate(delivery.date) }}</ion-text>
                </div>

                <!-- View Details Button (for all deliveries) -->
                <ion-button
                  expand="block"
                  fill="outline"
                  class="view-details-button"
                  (click)="openDeliveryModal(delivery)">
                  <ion-icon slot="start" name="eye-outline"></ion-icon>
                  View Details
                </ion-button>
              </ion-card-content>
            </ion-card>
          }
        </div>
      } @else {
        <ion-card class="empty-card">
          <ion-card-content>
            <ion-text class="empty-text">
              @if(filterStatus === 'all') {
                No deliveries found.
              } @else if(filterStatus === 'pending') {
                No pending deliveries for approval.
              } @else {
                No accepted deliveries yet.
              }
            </ion-text>
          </ion-card-content>
        </ion-card>
      }
    </ion-card-content>
  </ion-card>

  <!-- Delivery Approval Modal -->
  <ion-modal [isOpen]="isModalOpen()" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Approve Delivery: {{ selectedDelivery()?.deliveryNumber }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon slot="icon-only" name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-content">
        @if(selectedDelivery()) {
          <div class="modal-info">
            <ion-grid>
              <ion-row>
                <ion-col size="6">
                  <ion-text class="info-label">Customer</ion-text>
                  <ion-text class="info-value">{{ selectedDelivery()?.customerName || selectedDelivery()?.supplier || 'N/A' }}</ion-text>
                </ion-col>
                <ion-col size="6">
                  <ion-text class="info-label">Date</ion-text>
                  <ion-text class="info-value">{{ formatDate(selectedDelivery()?.date) }}</ion-text>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div class="products-section">
            <ion-text class="products-title">Products</ion-text>

            @for (product of selectedDelivery()!.products; track product.productId; let i = $index) {
              <ion-card class="product-card">
                <ion-card-content>
                  <ion-grid class="product-grid">
                    <!-- Product Image and Name -->
                    <ion-row class="product-row">
                      <ion-col size="12">
                        <div class="product-header">
                          <div class="product-image-container">
                            @if(product.productImage) {
                              <img 
                                [src]="product.productImage" 
                                [alt]="product.productName" 
                                class="product-image" 
                                (error)="product.productImage = undefined" />
                            }
                            @if(!product.productImage) {
                              <ion-icon name="image-outline" class="product-icon"></ion-icon>
                            }
                          </div>
                          <div class="product-name-container">
                            <ion-text class="product-label">Product Name</ion-text>
                            <ion-text class="product-name">{{ product.productName }}</ion-text>
                          </div>
                        </div>
                      </ion-col>
                    </ion-row>

                    <!-- Delivered Qty -->
                    <ion-row class="product-row">
                      <ion-col size="6">
                        <ion-text class="product-label">Delivered Qty</ion-text>
                        <ion-text class="product-value">{{ product.deliveredQty }}</ion-text>
                      </ion-col>
                      <ion-col size="6">
                        <ion-text class="product-label">Accepted Qty</ion-text>
                        <ion-text class="product-value accepted-qty">{{ product.acceptedQty }}</ion-text>
                      </ion-col>
                    </ion-row>

                    <!-- Return Qty Input (editable only for pending deliveries) -->
                    <ion-row class="product-row">
                      <ion-col size="12">
                        <div class="input-wrapper">
                          <ion-label class="input-label">Return Qty</ion-label>
                          <ion-item lines="none" class="input-item">
                            <ion-input
                              type="number"
                              [value]="product.returnQty"
                              (ionInput)="updateReturnQty(i, +($any($event.target).value || 0))"
                              [max]="product.deliveredQty"
                              [min]="0"
                              placeholder="Enter return quantity"
                              [disabled]="!isDeliveryEditable() || product.status === 'rejected'"
                              [readonly]="!isDeliveryEditable()"
                              class="return-input">
                            </ion-input>
                          </ion-item>
                        </div>
                      </ion-col>
                    </ion-row>

                    <!-- Return Reason Dropdown (only show if return qty > 0, editable only for pending) -->
                    @if(product.returnQty > 0) {
                      <ion-row class="product-row">
                        <ion-col size="12">
                          <div class="input-wrapper">
                            <ion-label class="input-label">Return Reason</ion-label>
                            <ion-item lines="none" class="input-item">
                              <ion-select
                                [value]="product.returnReason || ''"
                                (ionChange)="updateReturnReason(i, $event.detail.value)"
                                placeholder="Select Reason"
                                interface="action-sheet"
                                [disabled]="!isDeliveryEditable()"
                                class="return-reason-select">
                                <ion-select-option value="">Select Reason</ion-select-option>
                                <ion-select-option value="damaged">Damaged</ion-select-option>
                                <ion-select-option value="qty_mismatched">Qty Mismatched</ion-select-option>
                                <ion-select-option value="others">Others</ion-select-option>
                              </ion-select>
                            </ion-item>
                          </div>
                        </ion-col>
                      </ion-row>
                    }

                    <!-- Accept/Reject Buttons (only show for pending deliveries) -->
                    @if(isDeliveryEditable()) {
                      <ion-row class="product-row action-row">
                        <ion-col size="6">
                          <ion-button
                            expand="block"
                            fill="outline"
                            color="success"
                            [class.accepted-btn]="product.status === 'accepted'"
                            (click)="acceptProduct(i)"
                            [disabled]="product.status === 'accepted'">
                            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                            Accept
                          </ion-button>
                        </ion-col>
                        <ion-col size="6">
                          <ion-button
                            expand="block"
                            fill="outline"
                            color="danger"
                            [class.rejected-btn]="product.status === 'rejected'"
                            (click)="rejectProduct(i)"
                            [disabled]="product.status === 'rejected'">
                            <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                            Reject
                          </ion-button>
                        </ion-col>
                      </ion-row>
                    }
                  </ion-grid>
                </ion-card-content>
              </ion-card>
            }
          </div>

          <!-- Submit Button (only for pending deliveries) -->
          @if(isDeliveryEditable()) {
            <div class="submit-section">
              <ion-button
                expand="block"
                size="large"
                class="submit-button"
                (click)="submitDelivery()">
                <ion-text><strong>Submit</strong></ion-text>
              </ion-button>
            </div>
          }
        }
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
